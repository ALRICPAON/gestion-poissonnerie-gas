<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Achats</title>

  <link rel="stylesheet" href="../css/style.css">

  <!-- Firebase + Auth -->
  <script type="module" src="../js/firebase-init.js"></script>
  <script type="module" src="../js/auth.js"></script>

  <!-- SheetJS (XLSX) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

  <!-- CHARGEMENT MODULES ACHATS -->
  <script type="module" src="../js/load-achats.js"></script>
  <script type="module" src="../js/submit-achat.js"></script>

  <!-- ‚úÖ IMPORTS FOURNISSEURS -->
  <script type="module" src="../js/manage-af-map.js"></script>
  <script type="module" src="../js/import-scapmaree.js"></script>
  <script type="module" src="../js/import-criee.js"></script>
  <script type="module" src="../js/import-royalemaree.js"></script>

</head>

<body>

  <div class="top-bar">
    <button class="btn btn-muted" onclick="window.location.href='/pages/home.html'">‚Üê Retour accueil</button>

    <div class="filters" style="display:flex; gap:.5rem; align-items:center;">
      <label>
        Du
        <input type="date" id="filterFrom">
      </label>
      <label>
        au
        <input type="date" id="filterTo">
      </label>

      <input type="text" id="filterQuery" class="search-input" placeholder="üîç Rechercher fournisseur / d√©signation‚Ä¶">

      <button id="btnApplyFilters" class="btn">Filtrer</button>
      <button id="btnResetFilters" class="btn btn-muted">R√©initialiser</button>
    </div>

    <div style="margin-left:auto; display:flex; gap:.5rem;">
      <button class="btn" id="btnNewCommande">‚ûï Cr√©er Commande</button>
      <button class="btn btn-accent" id="btnNewBL">‚ûï Cr√©er BL</button>
    </div>

    <div style="display:flex; gap:.5rem; align-items:center; flex-wrap:wrap;">
      <!-- fichier source -->
      <input type="file" id="providerFile" accept=".xlsx,.csv,.pdf" />

      <!-- ‚úÖ Fournisseur (dissoci√© du format) -->
      <select id="crieeSupplier" title="Choisir la cri√©e">
        <option value="">-- Choisir fournisseur --</option>
        <option value="81268">Cri√©e St-Gilles (81268)</option>
        <option value="81269">Cri√©e Les Sables (81269)</option>
      </select>

      <!-- ‚úÖ Format (o√π se trouve le PLU dans le fichier) -->
      <select id="crieeFormat" title="O√π est le PLU dans votre fichier ?">
        <option value="">-- Format du fichier --</option>
        <option value="COLA">PLU en colonne A</option>
        <option value="COLB">PLU en colonne B</option>
      </select>

      <!-- Autres fournisseurs d√©j√† g√©r√©s -->
      <select id="providerSelect" title="Autres imports">
        <option value="">-- Autres imports --</option>
        <option value="SCAPMAREE">Scapmar√©e (10001)</option>
        <option value="DISTRIMER">Distrimer</option>
        <option value="ROYALEMAREE">Royale Mar√©e</option>
        <option value="SOGELMER">Sogelmer</option>
      </select>

      <button id="btnProviderImport">Importer</button>
      <div id="importStatus" style="margin-left:1rem;"></div>
    </div>

  </div>

  <h1>Achats</h1>

  <table>
    <thead>
      <tr>
        <th style="width:120px;">Date</th>
        <th>Fournisseur</th>
        <th>D√©signation fournisseur</th>
        <th style="width:110px;">Type</th>
        <th style="width:130px;">Montant HT</th>
        <th style="width:130px;">Montant TTC</th>
        <th style="width:110px;">Statut</th>
        <th style="width:120px;">Actions</th>
      </tr>
    </thead>

    <tbody id="achats-list">
      <!-- rempli par JS -->
    </tbody>
  </table>

  <!-- ‚úÖ SCRIPT D‚ÄôIMPORT -->
<script type="module">
  import { requireAuth } from "../js/auth.js";
  import { importScapmaree } from "../js/import-scapmaree.js";
  import { importCrieePLUcolA, importCrieePLUcolB } from "../js/import-criee.js";
  import { importRoyaleMaree } from "../js/import-royalemaree.js";


  requireAuth();

  const btn        = document.getElementById("btnProviderImport");
  const fileInput  = document.getElementById("providerFile");
  const status     = document.getElementById("importStatus");

  // S√©lecteurs CRI√âE (nouvelle logique)
  const crieeSupplier = document.getElementById("crieeSupplier");
  const crieeFormat   = document.getElementById("crieeFormat");

  // Autres imports
  const providerSelect = document.getElementById("providerSelect");

  btn.addEventListener("click", async () => {
    status.textContent = "";

    const file = fileInput.files[0];
    if (!file) return alert("üìÅ S√©lectionner un fichier");

    try {
      // ‚úÖ Si un format CRI√âE est choisi
      if (crieeFormat.value) {
        const supplier = crieeSupplier.value;
        const format   = crieeFormat.value;

        if (!supplier) return alert("‚ùó Choisir la cri√©e (81268 ou 81269)");
        if (!format)   return alert("‚ùó Choisir un format (PLU Col A / B)");

        if (format === "COLA") {
  await importCrieePLUcolA(file, supplier);
} else if (format === "COLB") {
  await importCrieePLUcolB(file, supplier);
} else {
          return alert("‚ùå Format non reconnu");
        }

        status.textContent = "‚úÖ Import Cri√©e termin√© !";
        return;
      }

      // ‚úÖ Sinon, on traite les autres imports (Scapmar√©e, etc.)
      const provider = providerSelect.value;
      if (!provider) return alert("‚ùó Choisir un fournisseur ou un format CRI√âE");

     if (provider === "SCAPMAREE") {
  await importScapmaree(file);
  status.textContent = "‚úÖ Import Scapmar√©e termin√© !";

} else if (provider === "ROYALEMAREE") {
  await importRoyaleMaree(file);
  status.textContent = "‚úÖ Import Royale Mar√©e termin√© !";

} else {
  alert("‚ùå Import non impl√©ment√© pour : " + provider);
  return;
}
    }
    catch (e) {
      console.error(e);
      alert("‚ùå Erreur import : " + e.message);
      status.textContent = "‚ùå Erreur";
    }
  });
</script>

</body>
</html>
