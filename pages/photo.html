<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Photo Sanitaire</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; padding: 1rem; background: #f9fafb; }
    h1 { font-size: 1.5rem; margin-bottom: 1rem; }
    #preview { margin: 1rem 0; max-width: 100%; border-radius: 0.5rem; box-shadow: 0 0 8px rgba(0,0,0,0.1); }
    button { padding: .5rem 1rem; font-size: 1rem; border: none; border-radius: .25rem; background: #3b82f6; color: white; cursor: pointer; }
    button:disabled { background: #9ca3af; cursor: not-allowed; }
    .info { margin: 0.5rem 0; font-size: 0.9rem; color: #374151; }
  </style>
  <script type="module">
    import { app, db } from "../js/firebase-init.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";
    import { doc, collectionGroup, getDocs, setDoc, Timestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const storage = getStorage(app);
    const lotId = new URLSearchParams(location.search).get("id");

    document.addEventListener("DOMContentLoaded", async () => {
      if (!lotId) return alert("Lot ID manquant dans l'URL.");
      document.querySelector("#lotId").textContent = lotId;

      // Cherche la ligne correspondant au lot dans tous les achats
      let lineRef = null, achatId = null, lineId = null;
      const snap = await getDocs(collectionGroup(db, "lignes"));
      snap.forEach(docSnap => {
        const data = docSnap.data();
        if (data.lot === lotId) {
          lineRef = docSnap.ref;
          lineId = docSnap.id;
          const pathParts = lineRef.path.split("/");
          achatId = pathParts[pathParts.indexOf("achats") + 1];
        }
      });

      if (!lineRef) return alert("Ligne introuvable pour ce lot.");

      const video = document.querySelector("video");
      const btn = document.querySelector("#btnCapture");
      const canvas = document.createElement("canvas");

      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
      video.srcObject = stream;

      btn.onclick = async () => {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext("2d").drawImage(video, 0, 0);

        btn.disabled = true;
        const blob = await new Promise(res => canvas.toBlob(res, "image/jpeg"));
        const path = `achats/${achatId}/lignes/${lineId}/photo-${Date.now()}.jpg`;
        const sref = storageRef(storage, path);
        await uploadBytes(sref, blob);
        const url = await getDownloadURL(sref);

        await setDoc(lineRef, {
          photo_url: url,
          received: true,
          qr_scanned: true,
          qr_scan_date: Timestamp.fromDate(new Date()),
          updatedAt: Timestamp.fromDate(new Date())
        }, { merge: true });

        document.querySelector("#preview").src = url;
        document.querySelector("#status").textContent = "âœ… Photo enregistrÃ©e avec succÃ¨s.";
        stream.getTracks().forEach(t => t.stop());
      };
    });
  </script>
</head>
<body>
  <h1>Photo Sanitaire</h1>
  <p class="info">Lot : <strong id="lotId"></strong></p>
  <video autoplay playsinline width="100%" style="max-width:480px; border-radius:0.5rem;"></video>
  <br><br>
  <button id="btnCapture">ðŸ“¸ Prendre la photo</button>
  <p class="info" id="status"></p>
  <img id="preview" style="display:block; max-width:100%;" />
</body>
</html>
