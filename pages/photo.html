<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Photo Sanitaire</title>
  <script type="module" src="../js/firebase-init.js"></script>
  <script type="module" src="../js/auth.js"></script>
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    .box { border: 1px solid #ccc; padding: 1rem; border-radius: 8px; }
    button { padding: .6rem 1.2rem; margin-top: 1rem; }
  </style>
</head>
<body>

  <h2>üì¶ R√©ception ‚Äì Photo sanitaire</h2>

  <p id="lot"></p>

  <div class="box">
    <input id="photoInput" type="file" accept="image/*" capture="environment">
    <button id="btnUpload">üì§ Envoyer</button>
  </div>

  <script type="module">
    import { app, db } from "../js/firebase-init.js";
    import {
      doc, getDocs, collection, query, where, setDoc, Timestamp
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import {
      getStorage, ref as storageRef, uploadBytes, getDownloadURL
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

    const storage = getStorage(app);

    // R√©cup LOT
    const params = new URLSearchParams(location.search);
    const lot = params.get("id");
    document.getElementById("lot").textContent = "Lot : " + lot;

    // R√©cup achat + ligne
    async function findLine() {
      const achatsSnap = await getDocs(collection(db, "achats"));
      for (const a of achatsSnap.docs) {
        const lignesCol = collection(a.ref, "lignes");
        const q2 = query(lignesCol, where("lot", "==", lot));
        const snap2 = await getDocs(q2);
        if (!snap2.empty) {
          return { achatId: a.id, lineId: snap2.docs[0].id };
        }
      }
      return null;
    }

    document.getElementById("btnUpload").addEventListener("click", async () => {
      const found = await findLine();
      if (!found) {
        alert("‚ùå Ligne introuvable.");
        return;
      }
      const { achatId, lineId } = found;

      const file = photoInput.files[0];
      if (!file) {
        alert("Choisis une photo");
        return;
      }

      const path = `achats/${achatId}/lignes/${lineId}/sanitaire-${Date.now()}.jpg`;
      const sref = storageRef(storage, path);

      await uploadBytes(sref, file);
      const url = await getDownloadURL(sref);

      await setDoc(
        doc(db, "achats", achatId, "lignes", lineId),
        {
          photo_url: url,
          received: true,
          qr_scanned: true,
          qr_scan_date: Timestamp.fromDate(new Date()),
          updatedAt: Timestamp.fromDate(new Date())
        },
        { merge: true }
      );

      alert("‚úÖ Photo enregistr√©e !");
      window.location.href = "/pages/achat-detail.html?id=" + achatId;
    });
  </script>

</body>
</html>
