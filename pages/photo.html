<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Photo Sanitaire</title>

  <!-- Firebase -->
  <script type="module" src="../js/firebase-init.js"></script>
  <script type="module" src="../js/auth.js"></script>

  <style>
    body { font-family: sans-serif; padding: 1rem; }
    .box { border: 1px solid #ccc; padding: 1rem; border-radius: 8px; }
    button { padding: .6rem 1.2rem; margin-top: 1rem; }
  </style>
</head>
<body>

  <h2>üì¶ R√©ception ‚Äì Photo sanitaire</h2>
  <h3 id="lotDisp"></h3>

  <div class="box">
    <input id="photoInput" type="file" accept="image/*" capture="environment">
    <button id="btnUpload">üì§ Envoyer</button>
  </div>

  <div id="status" style="margin-top:1rem;color:#888;"></div>

  <script type="module">
    import { app, db } from "../js/firebase-init.js";
    import { requireAuth } from "../js/auth.js";

    // ‚úÖ FORCE L‚ÄôAUTHENTIFICATION
    await requireAuth();

    import {
      doc, getDocs, collection, query, where, setDoc, Timestamp
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    import {
      getStorage, ref as storageRef, uploadBytes, getDownloadURL
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

    const storage = getStorage(app);

    const params = new URLSearchParams(location.search);
    const lot = params.get("id");
    document.getElementById("lotDisp").textContent = "Lot : " + lot;

    const statusEl = document.getElementById("status");

    function log(msg) {
      console.log("[photo]", msg);
      statusEl.textContent = msg;
    }

    // ‚úÖ Recherche Achat + Ligne
    async function findLine() {
      log("Recherche du lot‚Ä¶");

      const achatsSnap = await getDocs(collection(db, "achats"));

      for (const achat of achatsSnap.docs) {
        const lignesCol = collection(db, "achats", achat.id, "lignes");
        const q2 = query(lignesCol, where("lot", "==", lot));
        const snap2 = await getDocs(q2);

        if (!snap2.empty) {
          log(`‚úÖ Ligne trouv√©e ‚Üí achat: ${achat.id}`);
          return { achatId: achat.id, lineId: snap2.docs[0].id };
        }
      }
      return null;
    }


    // ‚úÖ Upload photo
    document.getElementById("btnUpload").addEventListener("click", async () => {
      try {
        log("‚Üí Recherche ligne‚Ä¶");
        const found = await findLine();

        if (!found) {
          alert("‚ùå Ligne introuvable pour ce LOT");
          log("‚ùå Ligne introuvable");
          return;
        }
        const { achatId, lineId } = found;

        const input = document.getElementById("photoInput");
        const file = input.files[0];
        if (!file) {
          alert("Choisis une photo");
          log("‚ùå Aucune photo s√©lectionn√©e");
          return;
        }

        log("‚Üí Upload en cours‚Ä¶");

        const path = `achats/${achatId}/lignes/${lineId}/sanitaire-${Date.now()}.jpg`;
        const sref = storageRef(storage, path);

        await uploadBytes(sref, file);
        const url = await getDownloadURL(sref);

        log("‚úÖ Upload OK ‚Üí URL: " + url);

        await setDoc(
          doc(db, "achats", achatId, "lignes", lineId),
          {
            photo_url: url,
            received: true,
            qr_scanned: true,
            qr_scan_date: Timestamp.now(),
            updatedAt: Timestamp.now()
          },
          { merge: true }
        );

        log("‚úÖ Firestore mis √† jour");

        alert("‚úÖ Photo enregistr√©e !");
        window.location.href = `/pages/achat-detail.html?id=${achatId}`;

      } catch (e) {
        console.error(e);
        alert("‚ùå Erreur : " + e.message);
        log("ERREUR : " + e.message);
      }
    });

  </script>

</body>
</html>
