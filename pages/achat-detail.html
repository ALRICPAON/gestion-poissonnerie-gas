<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>D√©tail Achat</title>
  <link rel="stylesheet" href="../css/style.css">

  <!-- Firebase app/auth/db/storage -->
  <script type="module" src="../js/firebase-init.js"></script>
  <script type="module" src="../js/auth.js"></script>

  <!-- jsPDF + QRCode -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>


  <!-- Module principal -->
  <script type="module" src="../js/load-achat-detail.js"></script>

  <style>
    .subline { font-size:.85rem; color:#9aa3af; margin-top:.25rem }
    .pill { display:inline-block; padding:.1rem .4rem; border:1px solid #374151; border-radius:.5rem; margin-right:.25rem; cursor:pointer }
    .pill.editing { background:#111827; color:#e5e7eb; }
    .pill input { background:transparent; border:none; outline:none; color:inherit; width:9rem }
    td .inp { width:100%; }
    td .txt-center { text-align:center; }
  </style>
</head>
<body>
  <div class="top-bar">
    <button class="btn btn-muted" onclick="history.back()">‚Üê Retour</button>
    <h1 style="margin-left:1rem;">D√©tail de l'achat</h1>
    <div style="margin-left:auto; display:flex; gap:.5rem;">

      <button id="btnSaveHeader" class="btn">üíæ Enregistrer l‚Äôen-t√™te</button>
      <button id="btnAddLine" class="btn">‚ûï Ajouter une ligne</button>
      <button id="btnConvertBL" class="btn btn-accent">üîÅ Convertir en BL</button>
      <button id="btnQRCodeSheet" class="btn btn-primary">Feuille QR code</button>

    </div>
  </div>

  <!-- En-t√™te achat -->
  <section class="card" style="margin:1rem;">
    <div class="grid" style="grid-template-columns: repeat(6, minmax(0,1fr)); gap:.75rem;">
      <label>Date
        <input type="date" id="achat-date">
      </label>
      <label>Code fournisseur
        <input type="text" id="achat-fourn-code" placeholder="81269‚Ä¶">
      </label>
      <label>Nom fournisseur
        <input type="text" id="achat-fourn-nom" placeholder="Cri√©e‚Ä¶">
      </label>
      <label>D√©signation fournisseur
        <input type="text" id="achat-fourn-desig" placeholder="N¬∞ BL / R√©f‚Ä¶">
      </label>
      <label>Type
        <select id="achat-type">
          <option value="commande">Commande</option>
          <option value="BL">BL</option>
        </select>
      </label>
      <label>Statut
        <select id="achat-statut">
          <option value="new">new</option>
          <option value="received">received</option>
          <option value="closed">closed</option>
        </select>
      </label>
      <label>Montant HT
        <input type="text" id="achat-total-ht" readonly>
      </label>
      <label>Montant TTC
        <input type="text" id="achat-total-ttc" readonly>
      </label>
    </div>
  </section>

  <!-- Lignes -->
  <section style="margin:1rem;">
    <table>
      <thead>
        <tr>
          <th style="width:96px;">PLU</th>
          <th>D√©signation & Tra√ßa</th>
          <th style="width:84px;">Colis</th>
          <th style="width:120px;">Poids/colis (kg)</th>
          <th style="width:120px;">Poids total (kg)</th>
          <th style="width:120px;">Prix/kg</th>
          <th style="width:120px;">Montant HT</th>
          <th style="width:130px;">Lot</th>
          <th style="width:110px;">DLC</th>
          <th style="width:40px;">QR</th>
          <th style="width:54px;">OK</th>
          <th style="width:180px;">Actions</th>
        </tr>
      </thead>
      <tbody id="achat-lines"></tbody>
    </table>
  </section>

  <!-- Popup Articles (F9) -->
  <div id="popup-articles" class="modal" style="display:none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Articles</h3>
        <button class="btn btn-muted" id="btnClosePopup">‚úñ</button>
      </div>
      <input type="text" id="search-articles" class="search-input" placeholder="üîç Rechercher PLU / D√©signation‚Ä¶">
      <table>
        <thead><tr><th>PLU</th><th>D√©signation</th><th>Nom latin</th><th>Cat√©gorie</th></tr></thead>
        <tbody id="articles-list"></tbody>
      </table>
      <p style="margin-top:.5rem;">Astuce : double-clique un article pour remplir la ligne en cours.</p>
    </div>
  </div>

  <!-- Auth check -->
  <script type="module">
    import { requireAuth } from '../js/auth.js';
    requireAuth();
  </script>

  <!-- QR Sheet -->
  <script type="module">
    import { generateQRCodeSheets } from "../js/generate-qrcodes.js";

    const params = new URLSearchParams(location.search);
    const achatId = params.get("id");

    console.log("Loaded achatId:", achatId);

    const btnQR = document.getElementById("btnQRCodeSheet");
    if (btnQR && achatId) {
      btnQR.addEventListener("click", () => {
        generateQRCodeSheets(achatId);
      });
    }
  </script>
<div id="popup-sanitaire" class="modal" style="
  display:none; position:fixed; inset:0;
  background:rgba(0,0,0,.6); padding:2rem;
  z-index:10000; overflow:auto;">
  
  <div style="background:white; padding:1rem; border-radius:10px; max-width:600px; margin:auto;">
    <h2>Lecture √©tiquette sanitaire</h2>
    <p><strong>Image d√©tect√©e :</strong></p>
    <img id="sanitaire-img" style="max-width:100%; border:1px solid #ccc; margin-bottom:1rem;" />

    <h3>Champs d√©tect√©s</h3>
    <label>Nom latin : <input id="san-nomlatin" style="width:100%"></label><br><br>
    <label>FAO : <input id="san-fao" style="width:100%"></label><br><br>
    <label>DLC : <input id="san-dlc" type="date" style="width:100%"></label><br><br>
    <label>Engin : <input id="san-engin" style="width:100%"></label><br><br>

    <div style="margin-top:1rem;display:flex;gap:1rem;">
      <button id="san-valider" class="btn btn-primary">‚úî Valider</button>
      <button id="san-fermer" class="btn btn-muted">‚úñ Annuler</button>
    </div>

    <pre id="san-raw" style="white-space:pre-wrap; background:#f3f3f3; padding:.5rem; margin-top:1rem; font-size:.8rem;"></pre>
  </div>

</div>

</body>
</html>
