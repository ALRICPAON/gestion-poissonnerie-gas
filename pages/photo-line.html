<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Photo sanitaire</title>

  <!-- Firebase -->
  <script type="module" src="../js/firebase-init.js"></script>

  <style>
    body {
      font-family: sans-serif;
      padding: 1rem;
      background: #fafafa;
      text-align: center;
    }

    h2 {
      font-size: 1.8rem;
      margin-bottom: 0.5rem;
    }

    .big-btn {
      width: 100%;
      padding: 1.6rem;
      margin: 1rem 0;
      font-size: 1.6rem;
      border-radius: 14px;
      border: none;
    }

    .btn-camera {
      background: #2270ff;
      color: white;
    }

    .btn-gallery {
      background: #ff9b00;
      color: white;
    }

    .btn-upload {
      background: #00b44b;
      color: white;
    }

    #preview {
      width: 100%;
      max-height: 60vh;
      object-fit: contain;
      margin-top: 1rem;
      border-radius: 14px;
      border: 2px solid #ccc;
      display: none;
    }

    #status {
      margin-top: 1.2rem;
      font-size: 1.4rem;
    }
  </style>

</head>
<body>

  <h2>üì∏ Photo sanitaire</h2>
  <p id="info"></p>

  <!-- INPUT PHOTO -->
  <input id="photoInput" type="file" accept="image/*" capture="environment" style="display:none" />

  <!-- BOUTONS CHOIX -->
  <button class="big-btn btn-camera" onclick="openCamera()">
    üì∏ Prendre une photo
  </button>

  <button class="big-btn btn-gallery" onclick="openGallery()">
    üìÅ Importer depuis la galerie
  </button>

  <!-- PREVIEW -->
  <img id="preview" />

  <!-- UPLOAD -->
  <button class="big-btn btn-upload" id="btnUpload">
    ‚úÖ Envoyer
  </button>

  <div id="status"></div>

  <script type="module">
    /* ------------------------------------------------------------------
       IMPORTS
    ------------------------------------------------------------------ */
    import { app, db } from "../js/firebase-init.js";

    import {
      doc,
      setDoc,
      Timestamp,
      getDocs,
      collection
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    import {
      getStorage,
      ref as storageRef,
      uploadBytes,
      getDownloadURL
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

    import {
      getAuth,
      signInAnonymously
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    const auth = getAuth();
    await signInAnonymously(auth).catch(() => {});

    const storage = getStorage(app, "gs://poissonnerie-gas.firebasestorage.app");


    /* ------------------------------------------------------------------
       PARAMS URL
    ------------------------------------------------------------------ */
    const ps      = new URLSearchParams(location.search);
    const achatId = ps.get("achatId");
    const lineId  = ps.get("lineId");

    document.getElementById("info").textContent =
      `Achat : ${achatId} / Ligne : ${lineId}`;

    const statusEl  = document.getElementById("status");
    const previewEl = document.getElementById("preview");
    const inputEl   = document.getElementById("photoInput");


    /* ------------------------------------------------------------------
       UI Buttons
    ------------------------------------------------------------------ */
    window.openCamera = () => {
      inputEl.setAttribute("capture", "environment");
      inputEl.click();
    };

    window.openGallery = () => {
      inputEl.removeAttribute("capture");
      inputEl.click();
      setTimeout(() => {
        inputEl.setAttribute("capture", "environment");
      }, 1000);
    };


    /* ------------------------------------------------------------------
       PREVIEW
    ------------------------------------------------------------------ */
    inputEl.addEventListener("change", () => {
      const f = inputEl.files?.[0];
      if (!f) return;
      previewEl.src = URL.createObjectURL(f);
      previewEl.style.display = "block";
    });


    /* ------------------------------------------------------------------
       CLICK ‚Üí UPLOAD
    ------------------------------------------------------------------ */
    document.getElementById("btnUpload").addEventListener("click", async () => {
      try {
        const file = inputEl.files?.[0];
        if (!file) {
          alert("Choisir une photo");
          return;
        }

        statusEl.textContent = "‚Üí Upload‚Ä¶";

        /* -----------------------------
           1) Upload dans Storage
        ----------------------------- */
        const path = `achats/${achatId}/lignes/${lineId}/sanitaire-${Date.now()}.jpg`;
        const sref = storageRef(storage, path);

        await uploadBytes(sref, file);
        const url = await getDownloadURL(sref);


        /* -----------------------------
           2) Mise √† jour de la ligne
        ----------------------------- */
        await setDoc(
          doc(db, "achats", achatId, "lignes", lineId),
          {
            photo_url    : url,
            received     : true,
            qr_scanned   : true,
            qr_scan_date : Timestamp.now(),
            updatedAt    : Timestamp.now()
          },
          { merge: true }
        );

        statusEl.textContent = "‚úÖ Photo enregistr√©e";


        /* -----------------------------
           3) V√©rifier si TOUT est re√ßu
        ----------------------------- */
        const lignesCol = collection(db, "achats", achatId, "lignes");
        const snap = await getDocs(lignesCol);

        let allReceived = true;
        snap.forEach(d => {
          const L = d.data();
          if (!L.received) allReceived = false;
        });

        // Si toutes re√ßues ‚Üí passer en BL
        if (allReceived) {
          await setDoc(
            doc(db, "achats", achatId),
            {
              type: "BL",
              statut: "received",
              updatedAt: Timestamp.now()
            },
            { merge: true }
          );
        }

        /* -----------------------------
           4) Retour
        ----------------------------- */
        setTimeout(() => {
          location.href = `/pages/photo-batch.html?achatId=${achatId}`;
        }, 500);

      } catch (e) {
        console.error(e);
        alert("Erreur : " + e.message);
        statusEl.textContent = "‚ùå " + e.message;
      }
    });
  </script>

</body>
</html>
