<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Photo sanitaire</title>

  <!-- Firebase -->
  <script type="module" src="../js/firebase-init.js"></script>

  <style>
    body {
      font-family: sans-serif;
      padding: 1rem;
      background: #fafafa;
      text-align: center;
    }

    h2 {
      font-size: 1.8rem;
    }

    .big-btn {
      width: 100%;
      padding: 1.6rem;
      margin: 1rem 0;
      font-size: 1.6rem;
      border-radius: 14px;
      border: none;
      display: block;
      text-align: center;
      cursor: pointer;
    }

    .btn-camera { background:#2270ff; color:white; }
    .btn-gallery { background:#ff9b00; color:white; }
    .btn-upload { background:#00b44b; color:white; }

    /* ‚úÖ iPhone compatibility */
    input[type=file] {
      position: absolute;
      top: -9999px;
      left: -9999px;
    }

    #preview {
      width: 100%;
      max-height: 60vh;
      object-fit: contain;
      margin-top: 1rem;
      border-radius: 14px;
      border: 2px solid #ccc;
      display: none;
    }

    #status {
      margin-top: 1.2rem;
      font-size: 1.4rem;
    }
  </style>
</head>

<body>

  <h2>üì∏ Photo sanitaire</h2>
  <p id="info"></p>

  <!-- ‚úÖ INPUT CAMERA -->
  <input id="inputCamera" type="file" accept="image/*" capture="environment" />

  <!-- ‚úÖ INPUT GALLERIE -->
  <input id="inputGallery" type="file" accept="image/*" />

  <!-- ‚úÖ LABELS = iPhone OK -->
  <label for="inputCamera" class="big-btn btn-camera">
    üì∏ Prendre une photo
  </label>

  <label for="inputGallery" class="big-btn btn-gallery">
    üìÅ Importer depuis la galerie
  </label>

  <!-- ‚úÖ PREVIEW -->
  <img id="preview" />

  <!-- ‚úÖ UPLOAD -->
  <button class="big-btn btn-upload" id="btnUpload">
    ‚úÖ Envoyer
  </button>

  <div id="status"></div>

<script type="module">
import { app, db } from "../js/firebase-init.js";

import {
  doc, setDoc, Timestamp, getDocs, collection
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

import {
  getStorage, ref as storageRef, uploadBytes, getDownloadURL
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

import {
  getAuth, signInAnonymously, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

/* -------------------------------------------------------------
   ‚úÖ Auth anonyme
------------------------------------------------------------- */
const auth = getAuth();
await signInAnonymously(auth).catch(() => {});

function waitAuth() {
  return new Promise((resolve) => {
    const stop = onAuthStateChanged(auth, (u) => {
      if (u) {
        stop();
        resolve(u);
      }
    });
  });
}
await waitAuth();

console.log("‚úÖ Anonymous Auth ready:", auth.currentUser?.uid);

/* -------------------------------------------------------------
   ‚úÖ Storage
------------------------------------------------------------- */
const storage = getStorage(app);

/* -------------------------------------------------------------
   URL params
------------------------------------------------------------- */
const ps = new URLSearchParams(location.search);
const achatId = ps.get("achatId");
const lineId  = ps.get("lineId");

document.getElementById("info").textContent =
  `Achat : ${achatId} / Ligne : ${lineId}`;

const statusEl   = document.getElementById("status");
const previewEl  = document.getElementById("preview");
const inputCam   = document.getElementById("inputCamera");
const inputGal   = document.getElementById("inputGallery");

let currentFile = null;

/* -------------------------------------------------------------
   ‚úÖ Preview (HEIC OK)
------------------------------------------------------------- */
function showPreview(file) {
  currentFile = file;
  const url = URL.createObjectURL(file);
  previewEl.src = url;
  previewEl.style.display = "block";
}

inputCam.addEventListener("change", e => {
  const f = e.target.files?.[0];
  if (f) showPreview(f);
});

inputGal.addEventListener("change", e => {
  const f = e.target.files?.[0];
  if (f) showPreview(f);
});


/* -------------------------------------------------------------
   ‚úÖ Upload
------------------------------------------------------------- */
document.getElementById("btnUpload").addEventListener("click", async () => {
  try {
    if (!currentFile) {
      alert("S√©lectionne une photo");
      return;
    }

    statusEl.textContent = "‚Üí Upload‚Ä¶";

    const path = `achats/${achatId}/lignes/${lineId}/sanitaire-${Date.now()}.jpg`;
    const sref = storageRef(storage, path);

    await uploadBytes(sref, currentFile);
    const url = await getDownloadURL(sref);

    await setDoc(
      doc(db, "achats", achatId, "lignes", lineId),
      {
        photo_url    : url,
        received     : true,
        qr_scanned   : true,
        qr_scan_date : Timestamp.now(),
        updatedAt    : Timestamp.now()
      },
      { merge: true }
    );

    statusEl.textContent = "‚úÖ Photo enregistr√©e";

    const snap = await getDocs(collection(db, "achats", achatId, "lignes"));
    let allReceived = true;
    snap.forEach(d => {
      if (!d.data().received) allReceived = false;
    });

    if (allReceived) {
      await setDoc(
        doc(db, "achats", achatId),
        {
          type: "BL",
          statut: "received",
          updatedAt: Timestamp.now()
        },
        { merge: true }
      );
    }

    setTimeout(() => {
      location.href = `/pages/photo-batch.html?achatId=${achatId}`;
    }, 600);

  } catch (e) {
    console.error(e);
    alert("Erreur : " + e.message);
    statusEl.textContent = "‚ùå " + e.message;
  }
});
</script>

</body>
</html>
