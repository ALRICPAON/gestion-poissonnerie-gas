<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Photo sanitaire</title>

  <!-- Firebase -->
  <script type="module" src="../js/firebase-init.js"></script>

  <style>
    body {
      font-family: sans-serif;
      padding: 1rem;
      background: #fafafa;
      text-align: center;
    }

    h2 {
      font-size: 1.8rem;
    }

    .big-btn {
      width: 100%;
      padding: 1.6rem;
      margin: 1rem 0;
      font-size: 1.6rem;
      border-radius: 14px;
      border: none;
      display: block;
      text-align: center;
      cursor: pointer;
    }

    .btn-camera { background:#2270ff; color:white; }
    .btn-gallery { background:#ff9b00; color:white; }
    .btn-upload { background:#00b44b; color:white; }

    /* ‚úÖ iPhone compatibility */
    input[type=file] {
      position: absolute;
      top: -9999px;
      left: -9999px;
    }

    #preview {
      width: 100%;
      max-height: 60vh;
      object-fit: contain;
      margin-top: 1rem;
      border-radius: 14px;
      border: 2px solid #ccc;
      display: none;
    }

    #status {
      margin-top: 1.2rem;
      font-size: 1.4rem;
    }
  </style>
</head>

<body>

  <h2>üì∏ Photo sanitaire</h2>
  <p id="info"></p>

  <!-- ‚úÖ INPUT CAMERA -->
  <input id="inputCamera" type="file" accept="image/*" capture="environment" />

  <!-- ‚úÖ INPUT GALLERIE -->
  <input id="inputGallery" type="file" accept="image/*" />

  <!-- ‚úÖ LABELS = iPhone OK -->
  <label for="inputCamera" class="big-btn btn-camera">
    üì∏ Prendre une photo
  </label>

  <label for="inputGallery" class="big-btn btn-gallery">
    üìÅ Importer depuis la galerie
  </label>

  <!-- ‚úÖ PREVIEW -->
  <img id="preview" />

  <!-- ‚úÖ UPLOAD -->
  <button class="big-btn btn-upload" id="btnUpload">
    ‚úÖ Envoyer
  </button>

  <div id="status"></div>

<script type="module">
import { app, db } from "../js/firebase-init.js";

import {
  doc,
  setDoc,
  Timestamp,
  getDocs,
  collection
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

import {
  getStorage,
  ref as storageRef,
  uploadBytes,
  getDownloadURL
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

import {
  getAuth,
  signInAnonymously
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

const auth = getAuth();
await signInAnonymously(auth).catch(() => {});
const storage = getStorage(app, "gs://poissonnerie-gas.firebasestorage.app");

const ps = new URLSearchParams(location.search);
const achatId = ps.get("achatId");
const lineId  = ps.get("lineId");

document.getElementById("info").textContent =
  `Achat : ${achatId} / Ligne : ${lineId}`;

const inputEl   = document.getElementById("photoInput");
const previewEl = document.getElementById("preview");
const statusEl  = document.getElementById("status");

let currentFile = null;


/* -------------------------------------------------------
‚úÖ Preview (fonctionnait sur iPhone)
-------------------------------------------------------- */
inputEl.addEventListener("change", (e) => {
  const f = e.target.files?.[0];
  if (!f) return;

  currentFile = f;
  previewEl.src = URL.createObjectURL(f);   // ‚úÖ iPhone OK
  previewEl.style.display = "block";
});


/* -------------------------------------------------------
‚úÖ Boutons ‚Äî version OK
-------------------------------------------------------- */
window.openCamera = () => {
  inputEl.setAttribute("capture", "environment");
  inputEl.click();
};

window.openGallery = () => {
  inputEl.removeAttribute("capture");
  inputEl.click();
};


/* -------------------------------------------------------
‚úÖ Envoi (c‚Äô√©tait FAIL √† cause des r√®gles)
-------------------------------------------------------- */
document.getElementById("btnUpload").addEventListener("click", async () => {
  try {
    if (!currentFile) {
      alert("Choisir une photo");
      return;
    }

    statusEl.textContent = "‚Üí Upload‚Ä¶";

    const path = `achats/${achatId}/lignes/${lineId}/sanitaire-${Date.now()}.jpg`;
    const sref = storageRef(storage, path);

    await uploadBytes(sref, currentFile);
    const url = await getDownloadURL(sref);

    await setDoc(
      doc(db, "achats", achatId, "lignes", lineId),
      {
        photo_url    : url,
        received     : true,
        qr_scanned   : true,
        qr_scan_date : Timestamp.now(),
        updatedAt    : Timestamp.now()
      },
      { merge: true }
    );

    statusEl.textContent = "‚úÖ Photo enregistr√©e";

    const lignesCol = collection(db, "achats", achatId, "lignes");
    const snap = await getDocs(lignesCol);

    let allReceived = true;
    snap.forEach(d => {
      if (!d.data().received) allReceived = false;
    });

    if (allReceived) {
      await setDoc(
        doc(db, "achats", achatId),
        {
          type: "BL",
          statut: "received",
          updatedAt: Timestamp.now()
        },
        { merge: true }
      );
    }

    setTimeout(() => {
      location.href = `/pages/photo-batch.html?achatId=${achatId}`;
    }, 300);

  } catch (e) {
    console.error(e);
    alert("Erreur : " + e.message);
    statusEl.textContent = "‚ùå " + e.message;
  }
});
</script>


</body>
</html>
