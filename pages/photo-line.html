<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Photo ligne</title>

  <!-- Firebase -->
  <script type="module" src="../js/firebase-init.js"></script>
  <script type="module" src="../js/auth.js"></script>

  <style>
    body { font-family:sans-serif; padding:1rem }
    button { padding:.6rem 1rem; margin-top:1rem }
  </style>
</head>
<body>

<h2>ğŸ“¸ Photo sanitaire</h2>
<p id="info"></p>

<input id="photoInput" type="file" accept="image/*" capture="environment">
<button id="btnUpload">ğŸ“¤ Envoyer</button>

<div id="status" style="margin-top:1rem;"></div>

<script type="module">
/* ------------------------------------------------------------------
   IMPORTS
------------------------------------------------------------------ */
import { app, db } from "../js/firebase-init.js";

import {
  doc,
  setDoc,
  Timestamp,
  getDocs,
  collection
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

import {
  getStorage,
  ref as storageRef,
  uploadBytes,
  getDownloadURL
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

const storage = getStorage(app, "gs://poissonnerie-gas.firebasestorage.app");
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

const auth = getAuth();
await signInAnonymously(auth).catch(() => {});



/* ------------------------------------------------------------------
   PARAMS URL
------------------------------------------------------------------ */
const ps      = new URLSearchParams(location.search);
const achatId = ps.get("achatId");
const lineId  = ps.get("lineId");

document.getElementById("info").textContent =
  `Achat : ${achatId} / Ligne : ${lineId}`;

const statusEl = document.getElementById("status");


/* ------------------------------------------------------------------
   CLICK â†’ UPLOAD
------------------------------------------------------------------ */
document.getElementById("btnUpload").addEventListener("click", async () => {
  try {
    const file = photoInput.files[0];
    if (!file) {
      alert("Choisir une photo");
      return;
    }

    statusEl.textContent = "â†’ Uploadâ€¦";

    // -----------------------------
    // 1) Upload dans Storage
    // -----------------------------
    const path = `achats/${achatId}/lignes/${lineId}/sanitaire-${Date.now()}.jpg`;
    const sref = storageRef(storage, path);

    await uploadBytes(sref, file);
    const url = await getDownloadURL(sref);


    // -----------------------------
    // 2) Mise Ã  jour de la ligne
    // -----------------------------
    await setDoc(
      doc(db, "achats", achatId, "lignes", lineId),
      {
        photo_url    : url,
        received     : true,
        qr_scanned   : true,
        qr_scan_date : Timestamp.now(),
        updatedAt    : Timestamp.now()
      },
      { merge: true }
    );

    statusEl.textContent = "âœ… Photo enregistrÃ©e";


    // -----------------------------
    // âœ… 3) VÃ©rifier si TOUT est reÃ§u
    // -----------------------------
    const lignesCol = collection(db, "achats", achatId, "lignes");
    const snap = await getDocs(lignesCol);

    let allReceived = true;
    snap.forEach(d => {
      const L = d.data();
      if (!L.received) allReceived = false;
    });

    // âœ… Si toutes les lignes sont received â†’ passage BL
    if (allReceived) {
      console.log("âœ… Tout reÃ§u â†’ Achat â†’ BL");

      await setDoc(
        doc(db, "achats", achatId),
        {
          type: "BL",
          statut: "received",
          updatedAt: Timestamp.now()
        },
        { merge: true }
      );
    }


    // -----------------------------
    // 4) Retour
    // -----------------------------
    setTimeout(() => {
      location.href = `/pages/photo-batch.html?achatId=${achatId}`;
    }, 300);

  } catch (e) {
    console.error(e);
    alert("Erreur : " + e.message);
    statusEl.textContent = "âŒ " + e.message;
  }
});
</script>

</body>
</html>

