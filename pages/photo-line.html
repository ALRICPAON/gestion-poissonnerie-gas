<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Photo sanitaire</title>

  <!-- Firebase -->
  <script type="module" src="../js/firebase-init.js"></script>

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      padding: 16px;
      background: #fafafa;
      text-align: center;
    }

    h2 { font-size: 1.9rem; margin: 0 0 .5rem; }

    .big-btn {
      width: 100%;
      padding: 1.6rem;
      margin: .8rem 0;
      font-size: 1.6rem;
      border-radius: 14px;
      border: none;
      display: inline-block;
      text-align: center;
      cursor: pointer;
    }

    .btn-camera  { background: #2270ff; color: #fff; }
    .btn-gallery { background: #ff9b00; color: #fff; }
    .btn-upload  { background: #00b44b; color: #fff; }

    /* iPhone-friendly: input prÃ©sent dans le DOM mais hors Ã©cran */
    input[type="file"] {
      position: absolute;
      left: -9999px;
      top: -9999px;
    }

    #preview {
      width: 100%;
      max-height: 60vh;
      object-fit: contain;
      margin-top: 1rem;
      border-radius: 14px;
      border: 2px solid #ccc;
      display: none;
      background: #fff;
    }

    #status {
      margin-top: 1.2rem;
      font-size: 1.2rem;
      color: #333;
      white-space: pre-wrap;
      text-align: left;
    }

    #info { color:#444; font-size: 1rem; }
  </style>
</head>
<body>

  <h2>ğŸ“¸ Photo sanitaire</h2>
  <p id="info"></p>

  <!-- âœ… 2 inputs distincts (camÃ©ra / galerie) -->
  <input id="inputCamera"  type="file" accept="image/*" capture="environment" />
  <input id="inputGallery" type="file" accept="image/*" />

  <!-- âœ… Labels = tap direct utilisateur (iPhone approuve) -->
  <label for="inputCamera" class="big-btn btn-camera">ğŸ“¸ Prendre une photo</label>
  <label for="inputGallery" class="big-btn btn-gallery">ğŸ“ Importer depuis la galerie</label>

  <!-- âœ… Preview -->
  <img id="preview" alt="AperÃ§u photo" />

  <!-- âœ… Upload -->
  <button class="big-btn btn-upload" id="btnUpload">âœ… Envoyer</button>

  <div id="status"></div>

  <script type="module">
    /* ------------------------------------------------------------------
       IMPORTS
    ------------------------------------------------------------------ */
    import { app, db } from "../js/firebase-init.js";

    import {
      doc, setDoc, Timestamp, getDocs, collection
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    import {
      getStorage, ref as storageRef, uploadBytes, getDownloadURL
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

    import {
      getAuth, signInAnonymously, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    /* ------------------------------------------------------------------
       Mini logger visible (utile sur iPhone sans console)
    ------------------------------------------------------------------ */
    const statusEl = document.getElementById("status");
    const log = (...args) => {
      console.log(...args);
      statusEl.textContent += args.map(a => typeof a === 'string' ? a : JSON.stringify(a)).join(' ') + "\\n";
    };

    log("ğŸŸ¢ Page chargÃ©e");

    /* ------------------------------------------------------------------
       âœ… Auth anonyme + attente
    ------------------------------------------------------------------ */
    const auth = getAuth();
    try {
      await signInAnonymously(auth);
    } catch (e) {
      log("âš ï¸ signInAnonymously:", e.message || e);
    }

    await new Promise((resolve) => {
      const stop = onAuthStateChanged(auth, (u) => {
        if (u) {
          stop();
          resolve();
        }
      });
    });
    log("âœ… Anonymous Auth OK:", auth.currentUser?.uid);

    /* ------------------------------------------------------------------
       âœ… Storage
    ------------------------------------------------------------------ */
    // Utilise le bucket par dÃ©faut de ton firebaseConfig (recommandÃ©)
    const storage = getStorage(app);
    log("âœ… Storage initialisÃ©");

    /* ------------------------------------------------------------------
       âœ… PARAMS URL
    ------------------------------------------------------------------ */
    const ps      = new URLSearchParams(location.search);
    const achatId = ps.get("achatId");
    const lineId  = ps.get("lineId");

    document.getElementById("info").textContent =
      `Achat : ${achatId} / Ligne : ${lineId}`;

    const previewEl  = document.getElementById("preview");
    const inputCam   = document.getElementById("inputCamera");
    const inputGal   = document.getElementById("inputGallery");
    const btnUpload  = document.getElementById("btnUpload");

    let currentFile = null;

    /* ------------------------------------------------------------------
       âœ… Preview (la version qui marchait chez toi)
    ------------------------------------------------------------------ */
    function showPreview(file) {
      currentFile = file;
      const url = URL.createObjectURL(file); // HEIC/HEIF OK
      previewEl.src = url;
      previewEl.style.display = "block";
      log("ğŸ–¼ï¸ Preview OK:", { name: file.name, size: file.size, type: file.type });
    }

    inputCam.addEventListener("change", (e) => {
      const f = e.target.files && e.target.files[0];
      if (!f) { log("âš ï¸ Camera: aucun fichier"); return; }
      showPreview(f);
    });

    inputGal.addEventListener("change", (e) => {
      const f = e.target.files && e.target.files[0];
      if (!f) { log("âš ï¸ Galerie: aucun fichier"); return; }
      showPreview(f);
    });

    /* ------------------------------------------------------------------
       âœ… Upload
    ------------------------------------------------------------------ */
    btnUpload.addEventListener("click", async () => {
      try {
        if (!currentFile) {
          alert("Choisir une photo");
          log("â›” Aucun fichier sÃ©lectionnÃ©");
          return;
        }

        log("â¬†ï¸ Upload en coursâ€¦");
        const path = `achats/${achatId}/lignes/${lineId}/sanitaire-${Date.now()}.jpg`;
        const sref = storageRef(storage, path);

        await uploadBytes(sref, currentFile);
        const url = await getDownloadURL(sref);
        log("âœ… Upload OK, URL:", url);

        await setDoc(
          doc(db, "achats", achatId, "lignes", lineId),
          {
            photo_url    : url,
            received     : true,
            qr_scanned   : true,
            qr_scan_date : Timestamp.now(),
            updatedAt    : Timestamp.now()
          },
          { merge: true }
        );
        log("âœ… Ligne mise Ã  jour (Firestore)");

        // VÃ©rifier si toutes les lignes sont reÃ§ues
        const snap = await getDocs(collection(db, "achats", achatId, "lignes"));
        let allReceived = true;
        snap.forEach(d => { if (!d.data().received) allReceived = false; });

        if (allReceived) {
          await setDoc(
            doc(db, "achats", achatId),
            { type: "BL", statut: "received", updatedAt: Timestamp.now() },
            { merge: true }
          );
          log("âœ… Achat passÃ© en BL/received");
        }

        setTimeout(() => {
          location.href = `/pages/photo-batch.html?achatId=${achatId}`;
        }, 600);

      } catch (e) {
        log("âŒ Erreur upload:", e.message || e);
        alert("Erreur : " + (e.message || e));
      }
    });

    /* ------------------------------------------------------------------
       âœ… Sanity-check iPhone : event â€œchangeâ€ dÃ©clenchÃ© ?
    ------------------------------------------------------------------ */
    // (Si jamais rien ne sâ€™affiche aprÃ¨s sÃ©lection, on verra ici des logs)
    ["focus","click","touchstart","touchend","change","input"].forEach(ev => {
      inputCam.addEventListener(ev, () => log(`ğŸ“± CAM event: ${ev}`));
      inputGal.addEventListener(ev, () => log(`ğŸ“± GAL event: ${ev}`));
    });

    log("ğŸ§ª PrÃªt. Ouvre camÃ©ra ou galerie.");
  </script>

</body>
</html>
